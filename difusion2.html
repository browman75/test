<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>氣體分子擴散與風力模擬器（Safari 修正版）</title>
  <style>
    body { text-align:center; font-family:sans-serif; background:#f0f8ff; }
    canvas { border:1px solid #333; background:white; margin-top:10px; }
    .controls { margin-top:10px; }
    label { margin:0 8px; }
  </style>
</head>
<body>
  <h2>氣體分子擴散與風力模擬器</h2>
  <div class="controls">
    <label>溫度: <input type="range" id="temp" min="1" max="10" step="0.5" value="5"></label>
    <label>分子大小: <input type="range" id="size" min="2" max="8" step="0.5" value="3"></label>
    <label><input type="checkbox" id="windToggle"> 開啟風</label>
    <label>風速: <input type="range" id="wind" min="0" max="5" step="0.2" value="0" disabled></label>
    <button id="reset">重置</button>
  </div>
  <canvas id="simCanvas" width="800" height="400"></canvas>
  <p id="stats"></p>

  <script>
    const canvas = document.getElementById("simCanvas");
    const ctx = canvas.getContext("2d");
    const tempSlider = document.getElementById("temp");
    const sizeSlider = document.getElementById("size");
    const windSlider = document.getElementById("wind");
    const windToggle = document.getElementById("windToggle");
    const resetBtn = document.getElementById("reset");
    const stats = document.getElementById("stats");

    const numParticles = 200;
    let particles = [];

    function resetParticles() {
      particles = [];
      for (let i = 0; i < numParticles; i++) {
        let color, x0;
        if (i < numParticles / 2) {
          color = "blue";
          x0 = Math.random() * (canvas.width / 2);
        } else {
          color = "red";
          x0 = canvas.width / 2 + Math.random() * (canvas.width / 2);
        }
        particles.push({
          x: x0,
          y: Math.random() * canvas.height,
          vx: (Math.random() - 0.5) * 2,
          vy: (Math.random() - 0.5) * 2,
          color: color
        });
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawParticles();
    }

    function drawParticles() {
      const size = parseFloat(sizeSlider.value);
      for (const p of particles) {
        ctx.beginPath();
        ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();
      }
    }

    function update() {
      const temp = parseFloat(tempSlider.value);
      const size = parseFloat(sizeSlider.value);
      const windEnabled = windToggle.checked;
      const wind = windEnabled ? parseFloat(windSlider.value) : 0;

      windSlider.disabled = !windEnabled;
      if (!windEnabled) windSlider.value = 0;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (const p of particles) {
        // 分子運動
        p.vx += (Math.random() - 0.5) * temp * 0.2;
        p.vy += (Math.random() - 0.5) * temp * 0.2;

        // 風力影響
        p.vx += wind * 0.1;

        // 阻尼（與粒子大小有關）
        const damping = 1 - size * 0.03;
        p.vx *= damping;
        p.vy *= damping;

        p.x += p.vx;
        p.y += p.vy;

        // 邊界反彈
        if (p.x < 0) { p.x = 0; p.vx *= -1; }
        if (p.x > canvas.width) { p.x = canvas.width; p.vx *= -1; }
        if (p.y < 0) { p.y = 0; p.vy *= -1; }
        if (p.y > canvas.height) { p.y = canvas.height; p.vy *= -1; }
      }

      drawParticles();

      const left = particles.filter(p => p.x < canvas.width / 2).length;
      const leftPct = (left / numParticles * 100).toFixed(1);
      stats.textContent = `左側分子比例：${leftPct}%　|　風速：${wind.toFixed(1)}`;

      requestAnimationFrame(update);
    }

    resetBtn.onclick = resetParticles;
    resetParticles();
    update();
  </script>
</body>
</html>
